---
name: Watch Upstream OMG Releases

on:
  schedule:
    # Run every Monday at 06:00 UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    name: Check for New OMG Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Read current release tag
        id: current
        run: |
          TAG=$(jq -r '.release_tag' scripts/config.json)
          # Validate tag format to prevent injection via config.json
          if ! [[ "$TAG" =~ ^[0-9]{4}-[0-9]{2}$ ]]; then
            echo "::error::Invalid current tag format: $TAG"
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Current tag: $TAG"

      - name: Fetch latest OMG release tags
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get tags from the OMG SysML v2 Release repo
          TAGS=$(gh api repos/Systems-Modeling/SysML-v2-Release/tags --jq '.[].name' | head -20)
          echo "Available tags:"
          echo "$TAGS"

          # Find the latest tag that looks like a release (YYYY-MM format)
          LATEST=$(echo "$TAGS" | grep -E '^[0-9]{4}-[0-9]{2}$' | sort -rV | head -1)

          # Validate tag format strictly before using it anywhere
          if [ -n "$LATEST" ] && ! [[ "$LATEST" =~ ^[0-9]{4}-[0-9]{2}$ ]]; then
            echo "::error::Invalid upstream tag format: $LATEST"
            exit 1
          fi

          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Latest release tag: $LATEST"

      - name: Compare versions
        id: compare
        env:
          CURRENT: ${{ steps.current.outputs.tag }}
          LATEST: ${{ steps.upstream.outputs.latest }}
        run: |
          if [ -z "$LATEST" ]; then
            echo "No upstream release tags found"
            echo "new_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$CURRENT" = "$LATEST" ]; then
            echo "Already up to date ($CURRENT)"
            echo "new_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "New release available: $CURRENT â†’ $LATEST"
            echo "new_release=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        if: steps.compare.outputs.new_release == 'true'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        if: steps.compare.outputs.new_release == 'true'
        run: pip install -r scripts/requirements.txt

      - name: Regenerate grammar with new tag
        id: regen
        if: steps.compare.outputs.new_release == 'true'
        env:
          LATEST: ${{ steps.upstream.outputs.latest }}
        run: |
          python scripts/generate_grammar.py --tag "$LATEST" --cache

          # Update config.json with new tag
          jq --arg tag "$LATEST" '.release_tag = $tag' scripts/config.json > /tmp/config.json
          mv /tmp/config.json scripts/config.json

      - name: Create Pull Request
        if: steps.compare.outputs.new_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT: ${{ steps.current.outputs.tag }}
          LATEST: ${{ steps.upstream.outputs.latest }}
        run: |
          BRANCH="upstream/$LATEST"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add -A
          git commit -m "chore: update grammar to OMG release $LATEST

          Upstream release changed from $CURRENT to $LATEST.
          Grammar files regenerated from Systems-Modeling/SysML-v2-Release@$LATEST."

          git push origin "$BRANCH"

          gh pr create \
            --title "Update grammar to OMG release $LATEST" \
            --body "## Upstream Release Update

          The OMG SysML v2 specification has a new release: **$LATEST** (was $CURRENT).

          ### Changes
          - Updated \`scripts/config.json\` release tag to \`$LATEST\`
          - Regenerated \`grammar/SysMLv2.g4\` and \`grammar/SysMLv2Lexer.g4\`

          ### Source
          [Systems-Modeling/SysML-v2-Release@$LATEST](https://github.com/Systems-Modeling/SysML-v2-Release/tree/$LATEST)

          > Auto-generated by the [watch-upstream](.github/workflows/watch-upstream.yml) workflow." \
            --base main \
            --head "$BRANCH"

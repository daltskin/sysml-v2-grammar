name: Generate & Validate Grammar

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'grammar/**'
      - '.github/workflows/generate.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'grammar/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate:
    name: Regenerate Grammar
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      - name: Regenerate grammar from OMG spec
        run: python scripts/generate_grammar.py --cache

      - name: Check for grammar drift
        run: |
          if git diff --exit-code grammar/; then
            echo "✅ Grammar files are up to date"
          else
            echo "⚠️ Grammar files have changed after regeneration"
            git diff grammar/
            exit 1
          fi

  validate:
    name: Validate with ANTLR4
    runs-on: ubuntu-latest
    needs: generate

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Java
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4.8.0
        with:
          distribution: temurin
          java-version: '17'

      - name: Download ANTLR4
        run: |
          curl -fsSL -o /tmp/antlr4.jar \
            https://www.antlr.org/download/antlr-4.13.2-complete.jar
          echo "eae2dfa119a64327444672aff63e9ec35a20180dc5b8090b7a6ab85125df4d76  /tmp/antlr4.jar" | sha256sum -c -

      - name: Compile grammar (Java target)
        run: |
          mkdir -p /tmp/antlr-out
          java -jar /tmp/antlr4.jar \
            -Dlanguage=Java \
            -o /tmp/antlr-out \
            grammar/SysMLv2Lexer.g4 grammar/SysMLv2.g4
          echo "✅ Grammar compiles successfully"

      - name: Compile grammar (TypeScript target)
        run: |
          mkdir -p /tmp/antlr-out-ts
          java -jar /tmp/antlr4.jar \
            -Dlanguage=TypeScript \
            -visitor -no-listener \
            -o /tmp/antlr-out-ts \
            grammar/SysMLv2Lexer.g4 grammar/SysMLv2.g4
          echo "✅ TypeScript target compiles successfully"

  parse-examples:
    name: Parse Example Files
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Java
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4.8.0
        with:
          distribution: temurin
          java-version: '17'

      - name: Download ANTLR4
        run: |
          curl -fsSL -o /tmp/antlr4.jar \
            https://www.antlr.org/download/antlr-4.13.2-complete.jar
          echo "eae2dfa119a64327444672aff63e9ec35a20180dc5b8090b7a6ab85125df4d76  /tmp/antlr4.jar" | sha256sum -c -

      - name: Compile grammar for testing
        run: |
          java -jar /tmp/antlr4.jar \
            -Dlanguage=Java \
            -o /tmp/antlr-test \
            grammar/SysMLv2Lexer.g4 grammar/SysMLv2.g4
          cd /tmp/antlr-test
          javac -cp "/tmp/antlr4.jar:." *.java

      - name: Parse example files
        run: |
          cd /tmp/antlr-test
          PASS=0
          FAIL=0
          for f in "$GITHUB_WORKSPACE"/examples/*.sysml; do
            echo -n "Parsing $(basename $f)... "
            if java -cp "/tmp/antlr4.jar:." org.antlr.v4.gui.TestRig SysMLv2 rootNamespace "$f" 2>&1 | grep -qi "error"; then
              echo "❌ FAIL"
              FAIL=$((FAIL + 1))
            else
              echo "✅ PASS"
              PASS=$((PASS + 1))
            fi
          done
          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          if [ $FAIL -gt 0 ]; then exit 1; fi
